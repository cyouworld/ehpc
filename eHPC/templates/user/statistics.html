{% extends 'base.html' %}

{% block header_ext %}

{% endblock %}

{% block content %}
    <div class="container">
        <div class="text-line">
            <h5><span>个人学习统计</span>
                <div class="line"></div>
            </h5>
        </div>

        <div class="es-section">
            <ul class="nav nav-tabs" role="tablist" id="tab-list">
                <li class="active"><a href="#this-week" role="tab" data-toggle="tab">本周统计</a></li>
            </ul>
            <div class="tab-content">
                <div id="this-week" class="tab-pane active">
                    <div class="row">
                        <h2 class="panel-heading" style="text-align: center"><span>本周</span></h2>
                        <div id="week-quiz-status" class="col-xs-12 col-sm-6 col-md-4 col-lg-4">
                            <canvas></canvas>
                        </div>
                        <div id="week-course-document-status" class="col-xs-12 col-sm-6 col-md-4 col-lg-8">
                            <canvas></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
{% endblock %}

{% block footer_ext %}
    <script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="{{ url_for('static', filename='js/Chart.min.js') }}"></script>
    <script>
        var statistics_this_week = {{ statistics | statistic_get_data('this-week') | safe }};
        var statistics_last_week = {{ statistics | statistic_get_data('last-week') | safe }};
        var statistics_month = {{ statistics | statistic_get_data('month') | safe }};

        $(function () {
            var quiz_status = statistics_this_week["{{ Statistic.ACTION_COURSE_SUBMIT_QUIZ_ANSWER }}"];
            var correct_counts = {}, wrong_counts = {};
            for (var i = 0; i < quiz_status.length; i++) {
                var c_sum = 0, w_sum = 0;
                for (var j in quiz_status[i]["data"]["result"]) {
                    if (quiz_status[i]["data"]["result"][j] === "T")
                        c_sum++;
                    else
                        w_sum++;
                }
                var paper_id = quiz_status[i]["data"]["paper_id"].toString();
                if (correct_counts.hasOwnProperty(paper_id)) {
                    if (correct_counts[paper_id] < c_sum)
                        correct_counts[paper_id] = c_sum;
                } else {
                    correct_counts[paper_id] = c_sum;
                }
                if (wrong_counts.hasOwnProperty(paper_id)) {
                    if (wrong_counts[paper_id] > w_sum)
                        wrong_counts[paper_id] = w_sum;
                } else {
                    wrong_counts[paper_id] = w_sum;
                }
            }

            var total_correct = 0, total_wrong = 0;
            for (i in correct_counts) {
                total_correct += correct_counts[i];
            }
            for (i in wrong_counts) {
                total_wrong += wrong_counts[i];
            }

            new Chart($("#week-quiz-status").find("canvas").eq(0), {
                type: "doughnut",
                data: {
                    datasets: [{
                        data: [total_correct, total_wrong],
                        backgroundColor: ['#8cd21b', '#ff6384']
                    }],
                    labels: [
                        "正确",
                        "错误"
                    ]
                },
                options: {
                    title: {
                        display: true,
                        fontSize: 16,
                        text: "课程测试答题正确比例"
                    },
                    tooltips: {
                        callbacks: {
                            label: function (tooltipItem, data) {
                                var dataSet = data.datasets[tooltipItem.datasetIndex];
                                var labels = data.labels[tooltipItem.datasetIndex];
                                var currentValue = dataSet.data[tooltipItem.index];
                                return " " + labels + " " + (currentValue / (total_correct + total_wrong)).toFixed(2) * 100 + "%";
                            }
                        }
                    }
                }
            });
        });
        $(function () {
            var this_week_document_status = statistics_this_week["{{ Statistic.ACTION_COURSE_VISIT_DOCUMENT_OR_VIDEO }}"];
            var last_week_document_status = statistics_last_week["{{ Statistic.ACTION_COURSE_VISIT_DOCUMENT_OR_VIDEO }}"];

            var status_data_this_week = [0, 0, 0, 0, 0, 0, 0], status_data_last_week = [0, 0, 0, 0, 0, 0, 0];

            for(i=0;i<this_week_document_status.length;i++){
                status_data_this_week[(new Date(this_week_document_status[i]["time"]).getDay() + 6) % 7]++;
            }
            for(i=0;i<last_week_document_status.length;i++){
                status_data_last_week[(new Date(last_week_document_status[i]["time"]).getDay() + 6) % 7]++;
            }

            new Chart($("#week-course-document-status").find("canvas").eq(0), {
                type: "bar",
                data: {
                    labels: ["一", "二", "三", "四", "五", "六", "日"],
                    datasets: [{
                        label: "文档浏览次数（本周）",
                        data: status_data_this_week,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)',
                            'rgba(204, 206, 209, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(204, 206, 209, 1)'
                        ],
                        borderWidth: 1
                    },{
                        label: "文档浏览次数（上周）",
                        data: status_data_last_week,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(153, 102, 255, 0.5)',
                            'rgba(255, 159, 64, 0.5)',
                            'rgba(204, 206, 209, 0.5)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(204, 206, 209, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    title: {
                        display: true,
                        fontSize: 16,
                        text: "课程文档学习情况"
                    },
                    scales: {
                        xAxes: [{
                            barPercentage: 0.618
                        }],
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                stepSize: 1
                            }
                        }]
                    }
                }
            });
        });
    </script>
{% endblock %}