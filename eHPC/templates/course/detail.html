{% extends 'course/widget_course_base.html' %}

{% block header_ext %}
    <script src="{{ url_for('static', filename='js/jquery.raty.js') }}"></script>
{% endblock %}


{% block course_page %}
    <div class="col-lg-9 col-md-8  course-detail-main">
        <section class="es-section">
            <div class="nav-btn-tab">
                <ul class="nav nav-tabs" role="tablist" id="course-content">
                    <li role="presentation"><a href="#about" role="tab" data-toggle="tab">课程概览</a></li>
                    <li role="presentation"><a href="#lists" role="tab" data-toggle="tab">课时列表</a></li>
                    <li role="presentation"><a href="#test" role="tab" data-toggle="tab">课堂试卷</a></li>
                    <li role="presentation"><a href="#comment" role="tab" data-toggle="tab">课堂评价</a></li>
                </ul>
            </div>

            <!-- Tab panes -->
            <div class="tab-content markdown-body">
                <div id="course-about" role="tabpanel" class="tab-pane">
                    <p>{{ course.about | markdown | safe }}</p>
                </div>

                <div id="course-lists" role="tabpanel" class="tab-pane">
                </div>

                <div id="course-test" role="tabpanel" class="tab-pane">
                    <div class="course-detail-content" data-widget-cid="widget-1">
                        <div class="es-piece">
                            <div class="piece-body">
                                <ul class="period-list" id="course-item-list">
                                    {% for p in papers %}
                                        <li class="period" data-paper_id="{{ p.id }}">
                                            <a href="{{ url_for('course.paper_detail', pid=p.id) }}" title="{{ p.title }}">
                                                <i class="es-icon es-icon-undone"></i>
                                                <span class="title"> {{ p.title }}</span>

                                                <span class="course-type">
                                                    <i class="es-icon es-icon-check"></i>
                                                </span>
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="course-comment" role="tabpanel" class="tab-pane">
                    {% if user.id %}
                        <div id="comment-edit-block">
                            <div class="form-group controls">
                                评分： <span id="raty"></span>
                            </div>
                            <div class="form-group">
                                <textarea id="comment-editor" class="form-control" rows="8" name="content" ></textarea>
                            </div>
                            <div class="form-group clearfix">
                                <div class="pull-right">
                                    <button id="comment-save-btn" class="btn btn-primary">保存</button>
                                    <button id="comment-cancel-btn" class="btn btn-info">取消</button>
                                </div>
                            </div>
                        </div>
                        <div id="re-edit" class="form-group clearfix">
                            <div class="pull-left" style="margin-left: 20px">
                                评分： <span id="show-raty"></span>
                            </div>
                            <div class="pull-right">
                                <button class="btn btn-primary">重新评价</button>
                            </div>
                        </div>
                    {% endif %}
                    <div id="comment-list"></div>
                </div>
            </div>
        </section>
    </div>

{% endblock %}

{% block footer_ext %}
    {{ super() }}
    <script>
        $(document).ready(function () {
            var op = "";

            $("#course-lists").empty().html("<div id='loading'><img src='{{ url_for('static', filename='images/loading.gif') }}' alt='Loading' /></div>");
            /* 加载课程列表内容 */
            $.ajax({
                url: "{{ url_for('course.detail_lessons', cid=course.id) }}",
                dataType: "json",
                contentType: 'application/json;charset=UTF-8',
                success: function (html) {
                    $("#course-lists").empty().html(html.data);
                },
                error: function () {
                    $("#course-lists").empty().html("<h2 style='text-align: center'> 课程内容为空或者出现其他错误 </h2>");
                }
            });

            $("#comment-list").empty().html("<div id='loading'><img src='{{ url_for('static', filename='images/loading.gif') }}' alt='Loading' /></div>");
            /* 加载课程评论内容 */
            $.ajax({
                url: "{{ url_for('course.process_comment') }}",
                type: "post",
                data: {
                    op: "data",
                    cid: "{{ course.id }}"
                },
                success: function (data) {
                    $("#comment-list").empty().html(data["html"]);
                    if (data["state"] == 0)
                    {
                        $("#comment-edit-block").show();
                        $("#re-edit").hide();
                        op = "create";
                    }
                    else if (data["state"] == 1)
                    {
                        $("#comment-edit-block").hide();
                        $("#re-edit").show();
                        op = "edit";
                    }
                    else
                    {
                        $("#comment-edit-block").hide();
                        $("#re-edit").hide();
                    }
                },
                error: function () {
                    $("#comment-list").empty().html("<h2 style='text-align: center'> 课程评论为空或者出现其他错误 </h2>");
                }
            });

            /* 根据tab 参数来指定默认显示的tab选项卡 */
            var tab = "{{ tab }}";
            if (tab == "lists") {
                $("#course-content").removeClass('active');
                $("#course-content li:nth-child(2)").addClass('active');
                $("#course-about").removeClass('active');
                $('#course-test').removeClass('active');
                $('#course-comment').removeClass('active');
                $("#course-lists").addClass('active');
            }
            else if (tab == "about") {
                $("#course-content").removeClass('active');
                $("#course-content li:nth-child(1)").addClass('active');
                $("#course-lists").removeClass('active');
                $('#course-test').removeClass('active');
                $('#course-comment').removeClass('active');
                $("#course-about").addClass('active');
            }
            else if (tab == "test") {
                $("#course-content").removeClass('active');
                $("#course-content li:nth-child(3)").addClass('active');
                $("#course-lists").removeClass('active');
                $("#course-about").removeClass('active');
                $('#course-comment').removeClass('active');
                $('#course-test').addClass('active');
            }
            else if (tab == "comment") {
                $("#course-content").removeClass('active');
                $("#course-content li:nth-child(4)").addClass('active');
                $("#course-lists").removeClass('active');
                $("#course-about").removeClass('active');
                $("#course-test").removeClass('active');
                $('#course-comment').addClass('active');
            }

            $("#course-content li a").click(function () {
                $("#course-content li").removeClass('active');
                $(this).parent().addClass('active');
                if ($(this).attr('href') == '#about') {
                    $("#course-lists").removeClass('active');
                    $('#course-test').removeClass('active');
                    $('#course-comment').removeClass('active');
                    $("#course-about").addClass('active');
                }
                else if ($(this).attr('href') == '#lists') {
                    $("#course-about").removeClass('active');
                    $('#course-test').removeClass('active');
                    $('#course-comment').removeClass('active');
                    $("#course-lists").addClass('active');
                }
                else if ($(this).attr('href') == '#test') {
                    $("#course-lists").removeClass('active');
                    $("#course-about").removeClass('active');
                    $('#course-comment').removeClass('active');
                    $('#course-test').addClass('active');
                }
                else if ($(this).attr('href') == '#comment') {
                    $("#course-lists").removeClass('active');
                    $("#course-about").removeClass('active');
                    $('#course-test').removeClass('active');
                    $('#course-comment').addClass('active');
                }
                $("#raty").raty({
                    starOff: "{{ url_for('static', filename='images/star-off.png') }}",
                    starOn: "{{ url_for('static', filename='images/star-on.png') }}",
                    starHalf: "{{ url_for('static', filename='images/star-half.png') }}"
                });

                $("#show-raty").raty({
                    starOff: "{{ url_for('static', filename='images/star-off.png') }}",
                    starOn: "{{ url_for('static', filename='images/star-on.png') }}",
                    starHalf: "{{ url_for('static', filename='images/star-half.png') }}",
                    readOnly: true,
                    score: {{ course.rank }}
                });

                $("#comment-save-btn").click(function () {
                    $.ajax({
                        url: "{{ url_for('course.process_comment') }}",
                        type: "post",
                        data :{
                            op: op,
                            rank: $("#raty").raty("score") ? $("#raty").raty("score") : 0,
                            content: $("#comment-editor").val(),
                            courseId: "{{ course.id }}"
                        },
                        success: function (data) {
                            alert("提交成功");
                            $.ajax({
                                url: "{{ url_for('course.process_comment') }}",
                                type: "post",
                                data: {
                                    op: "data",
                                    cid: "{{ course.id }}"
                                },
                                success: function (data) {
                                    $("#comment-list").empty().html(data["html"]);
                                    $("#comment-editor").val("");
                                    $("#comment-edit-block").hide();
                                    $("#re-edit").show();
                                }
                            });
                            $("#raty").raty("score", 0);
                            $("#show-raty").raty("set", { "score": data["rank"] });
                            op = "edit";
                        }
                    });
                });

                $("#comment-cancel-btn").click(function () {
                    $("#comment-editor").val("");
                    $("#comment-edit-block").hide();
                    $("#re-edit").show();
                });

                $("#re-edit").find("button").click(function () {
                    $("#re-edit").hide();
                    $("#comment-edit-block").show();
                });

            });
        });
    </script>
{% endblock %}
{# course #}